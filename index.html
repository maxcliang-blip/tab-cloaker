<!DOCTYPE html>
<html>
<head>
    <title>404 Not Found</title>
    <link rel="icon" type="image/png" href="https://ssl.gstatic.com">
    <style>
        body { margin: 0; font-family: sans-serif; background: #fff; height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        #shadow { text-align: center; color: #333; }
        #error404 { font-size: 50px; cursor: default; user-select: none; }
        .trigger { cursor: pointer; color: inherit; }
        
        #mainUI { display: none; background: #111; color: white; min-height: 100vh; width: 100%; flex-direction: column; justify-content: center; align-items: center; }
        .container { background: #222; padding: 30px; border-radius: 10px; text-align: center; border: 1px solid #444; width: 500px; box-shadow: 0 10px 30px rgba(0,0,0,0.8); }
        input { display: block; width: 90%; padding: 12px; margin: 8px auto; border-radius: 5px; border: 1px solid #555; background: #000; color: #0f0; font-family: monospace; }
        button { padding: 10px 20px; cursor: pointer; background: #1a73e8; color: white; border: none; border-radius: 5px; font-weight: bold; width: 100%; margin-top: 10px; }
        .launch-btn { background: #34a853; font-size: 1.1rem; }
        label { display: block; text-align: left; margin: 10px 20px 0 20px; font-size: 0.8rem; color: #888; }
        #favList { margin-top: 10px; text-align: left; background: #111; padding: 10px; border: 1px solid #333; max-height: 150px; overflow-y: auto; font-size: 0.8rem; }
        .inline-row { display:flex; align-items:center; justify-content:flex-start; gap:8px; margin: 4px 20px; }
        .inline-row input[type="checkbox"] { width:auto; margin:0; }

        .fav-item { display:flex; flex-direction:column; padding:4px 0; border-bottom:1px solid #222; }
        .fav-main { display:flex; align-items:center; justify-content:space-between; gap:6px; }
        .fav-link { cursor:pointer; color:#4285F4; word-break:break-all; }
        .fav-remove { background:#b00020; color:#fff; border:none; border-radius:3px; padding:3px 6px; font-size:0.7rem; cursor:pointer; }
        .fav-preview { font-size:0.7rem; color:#aaa; margin-left:2px; margin-top:2px; }
    </style>
</head>
<body onload="init()">

    <div id="shadow">
        <h1 id="error404">Error <span class="trigger" onclick="unlock()">4</span>04</h1>
        <p>The requested URL was not found on this server.</p>
    </div>

    <div id="mainUI">
        <div class="container">
            <h1>Elite Cloaker v31 (UV)</h1>
            <input type="password" id="pswd" placeholder="Master Key...">
            
            <div id="controls" style="display:none;">
                <label>1. Your Proxy Base URL:</label>
                <input type="text" id="uvBase" placeholder="https://example.com/service/" value="">
                
                <label>2. Target Site:</label>
                <input type="text" id="target" placeholder="https://google.com">

                <div class="inline-row">
                    <input type="checkbox" id="useProxy" checked>
                    <span style="font-size:0.8rem;color:#ccc;">Use proxy (UV/Scramjet)</span>
                </div>

                <button onclick="saveLink()">Save Link</button>
                <div id="favList">No Saved Links</div>

                <hr style="border:0; border-top:1px solid #444; margin:15px 0;">
                
                <input type="text" id="panic" value="https://classroom.google.com">
                <button class="launch-btn" onclick="launch()">Launch Cloak</button>
            </div>
            
            <button id="unlckBtn" onclick="verify()">Unlock</button>
        </div>
    </div>

    <script>
        const PASS = "LAXMIANGLIKESTOBANG"; // not real security

        // cache DOM refs
        let shadow, mainUI, pswdInput, controlsDiv, unlockBtn, uvBaseInput, targetInput, favListDiv, panicInput, useProxyCheckbox;

        function init() {
            shadow = document.getElementById('shadow');
            mainUI = document.getElementById('mainUI');
            pswdInput = document.getElementById('pswd');
            controlsDiv = document.getElementById('controls');
            unlockBtn = document.getElementById('unlckBtn');
            uvBaseInput = document.getElementById('uvBase');
            targetInput = document.getElementById('target');
            favListDiv = document.getElementById('favList');
            panicInput = document.getElementById('panic');
            useProxyCheckbox = document.getElementById('useProxy');

            checkSecurity();
            renderFavs();

            const savedBase = localStorage.getItem('uvBase') || "";
            uvBaseInput.value = savedBase;
        }

        function unlock() {
            shadow.style.display = 'none';
            mainUI.style.display = 'flex';
            document.title = "Classes";
        }

        function isValidUrl(str) {
            try { new URL(str); return true; } catch { return false; }
        }

        function verify() {
            const lockUntil = parseInt(localStorage.getItem('lockUntil') || "0", 10);
            if (Date.now() < lockUntil) {
                alert("System locked. Try again later.");
                return;
            }

            const input = pswdInput.value;
            let failCount = parseInt(localStorage.getItem('failCount') || "0", 10);

            if (input === PASS) {
                failCount = 0;
                localStorage.setItem('failCount', "0");
                controlsDiv.style.display = 'block';
                unlockBtn.style.display = 'none';
                pswdInput.style.display = 'none';
                renderFavs();
                uvBaseInput.value = localStorage.getItem('uvBase') || "";
            } else {
                failCount++;
                localStorage.setItem('failCount', String(failCount));
                if (failCount >= 5) {
                    const lockForMs = 10 * 60 * 1000;
                    localStorage.setItem('lockUntil', String(Date.now() + lockForMs));
                    alert("Too many attempts. Locked for 10 minutes.");
                    location.reload();
                } else {
                    alert("Incorrect key.");
                }
            }
        }

        // FAVORITES STORAGE FORMAT:
        // encFavs: array of { u: base64(url), p: previewText }
        function getFavs() {
            try {
                const raw = localStorage.getItem('encFavs');
                if (!raw) return [];
                const parsed = JSON.parse(raw);
                // backward compat: if it was just an array of strings
                if (parsed.length && typeof parsed[0] === 'string') {
                    return parsed.map(s => ({ u: s, p: "" }));
                }
                return parsed;
            } catch {
                return [];
            }
        }
        function setFavs(arr) {
            localStorage.setItem('encFavs', JSON.stringify(arr));
        }

        async function saveLink() {
            const url = targetInput.value.trim();
            if (!isValidUrl(url)) {
                alert("Enter a valid URL.");
                return;
            }
            let favs = getFavs();

            const enc = btoa(url);
            // avoid duplicates
            if (favs.some(f => f.u === enc)) {
                alert("That link is already saved.");
                return;
            }

            // basic preview: try to fetch title; fall back to hostname
            const preview = await fetchPreview(url);

            favs.push({ u: enc, p: preview });
            setFavs(favs);
            renderFavs();
        }

        // Try to get a small preview (title or hostname).
        async function fetchPreview(url) {
            try {
                // Most sites will block this with CORS; that's fine, we fallback.
                const res = await fetch(url, { method: 'GET' });
                const text = await res.text();
                const match = text.match(/<title[^>]*>([^<]*)<\/title>/i);
                if (match && match[1]) {
                    return match[1].trim().slice(0, 80);
                }
            } catch (e) {
                // ignore
            }
            try {
                const u = new URL(url);
                return u.hostname;
            } catch {
                return url.slice(0, 80);
            }
        }

        function removeFav(index) {
            let favs = getFavs();
            if (index < 0 || index >= favs.length) return;
            favs.splice(index, 1);
            setFavs(favs);
            renderFavs();
        }

        function renderFavs() {
            const favs = getFavs();
            favListDiv.innerHTML = '';

            if (!favs.length) {
                favListDiv.textContent = 'No Saved Links';
                return;
            }

            favs.forEach((item, idx) => {
                const dec = atob(item.u);
                const previewText = item.p || "";

                const wrapper = document.createElement('div');
                wrapper.className = 'fav-item';

                const mainRow = document.createElement('div');
                mainRow.className = 'fav-main';

                const linkSpan = document.createElement('span');
                linkSpan.className = 'fav-link';
                linkSpan.textContent = dec;
                linkSpan.addEventListener('click', () => {
                    targetInput.value = dec;
                });

                const rmBtn = document.createElement('button');
                rmBtn.className = 'fav-remove';
                rmBtn.textContent = 'Remove';
                rmBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    removeFav(idx);
                });

                mainRow.appendChild(linkSpan);
                mainRow.appendChild(rmBtn);
                wrapper.appendChild(mainRow);

                if (previewText) {
                    const prev = document.createElement('div');
                    prev.className = 'fav-preview';
                    prev.textContent = previewText;
                    wrapper.appendChild(prev);
                }

                favListDiv.appendChild(wrapper);
            });
        }

        function launch() {
            const baseRaw = (uvBaseInput.value || '').trim();
            const uvBase = baseRaw.replace(/\/$/, "");
            const targetUrl = targetInput.value.trim();
            const esc = (panicInput.value.trim() || "https://classroom.google.com");
            const useProxy = useProxyCheckbox.checked;

            if (!isValidUrl(targetUrl)) {
                alert("Enter a valid target URL.");
                return;
            }

            if (useProxy) {
                if (!uvBase) {
                    alert("Set your proxy base URL first or uncheck 'Use proxy'.");
                    return;
                }
                localStorage.setItem('uvBase', uvBase);
            }

            let finalUrl;
            if (useProxy) {
                const encodedUrl = btoa(targetUrl)
                    .replace(/\//g, '_')
                    .replace(/\+/g, '-')
                    .replace(/=/g, '');
                finalUrl = `${uvBase}/${encodedUrl}`;
            } else {
                finalUrl = targetUrl;
            }

            const pageHTML = `
                <html>
                <head>
                    <title>Classes</title>
                    <link rel="icon" type="image/png" href="https://ssl.gstatic.com">
                    <style>body,html{margin:0;padding:0;height:100%;overflow:hidden;background:#000;}iframe{width:100%;height:100%;border:none;}</style>
                </head>
                <body>
                    <iframe src="${finalUrl}"></iframe>
                    <script>
                        window.onbeforeunload = () => "Safety";
                        window.addEventListener('keydown', (e) => {
                            if (e.code === 'Backslash') {
                                window.onbeforeunload = null;
                                window.location.replace("${esc}");
                            }
                        });
                    <\\/script>
                </body>
                </html>
            `;

            const blob = new Blob([pageHTML], { type: 'text/html' });
            const win = window.open('about:blank', '_blank');
            if (!win) {
                alert("Popup blocked. Allow popups for this site.");
                return;
            }
            win.location.href = URL.createObjectURL(blob);
        }

        function checkSecurity() {
            const lockUntil = parseInt(localStorage.getItem('lockUntil') || "0", 10);
            if (Date.now() < lockUntil) {
                document.body.innerHTML = "<h1 style='color:red; text-align:center; margin-top:100px;'>SYSTEM LOCKED</h1>";
            }
        }

        window.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === '\\') {
                const esc = (panicInput && panicInput.value) || "https://classroom.google.com";
                window.location.replace(esc);
            }
        });
    </script>
</body>
</html>
